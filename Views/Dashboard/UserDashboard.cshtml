@model RentMate.Models.DashboardViewModel
@{
    ViewData["Title"] = "My Dashboard";
}

<div class="container mt-5">
    <h2 class="text-center mb-4">My Dashboard</h2>

    <div class="row g-4">
        <!-- My Items Section -->
        <div class="col-12">
            <div class="card shadow-sm p-4">
                <h4 class="mb-3">My Items</h4>
                @if (Model.Listings != null && Model.Listings.Any())
                {
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Listed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Listings)
                            {
                                <tr>
                                    <td>@item.Title</td>
                                    <td>@item.Description</td>
                                    <td>@item.Price</td>
                                    <td>@(item.IsListed ? "Yes" : "No")</td>
                                    <td>
                                        <button class="btn btn-sm @(item.IsListed ? "btn-warning" : "btn-success")"
                                                onclick="toggleListing(@item.Id, this)">
                                            @(item.IsListed ? "Unlist" : "List Item")
                                        </button>

                                        <a asp-controller="Items" asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning">Edit</a>
                                        <a asp-controller="Items" asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-danger">Delete</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>You have not listed any items yet.</p>
                }
            </div>
        </div>

        <!-- My Rentals Section -->
        <div class="col-12 mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>My Rentals</h4>
                <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target="#createRentalForm" aria-expanded="false" aria-controls="createRentalForm">
                    + Create Rental
                </button>
            </div>

            <div class="collapse mb-4" id="createRentalForm">
                <div class="card card-body shadow-sm">
                    <form asp-action="RentItem" asp-controller="Rentals" method="post">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Select Item</label>
                                <select class="form-select" name="itemId" required>
                                    <option value="">-- Select --</option>
                                    @foreach (var item in Model.Listings.Where(i => i.IsListed && !i.IsRented))
                                    {
                                        <option value="@item.Id">@item.Title</option>
                                    }

                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" name="startDate" required />
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" name="endDate" required />
                            </div>
                        </div>

                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">Create Rental</button>
                        </div>
                    </form>

                </div>
            </div>

                @if (Model.Rentals != null && Model.Rentals.Any())
                {
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Status</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var rental in Model.Rentals)
                            {
                                <tr>
                                    <td>@rental.Item.Title</td>
                                    <td>@rental.Status</td>
                                    <td>@(rental.StartDate?.ToShortDateString() ?? "N/A")</td>
                                    <td>@(rental.EndDate?.ToShortDateString() ?? "N/A")</td>
                                    <td>
                                        <a asp-controller="Rentals" asp-action="Edit" asp-route-id="@rental.Id" class="btn btn-sm btn-warning">Edit</a>
                                        <a asp-controller="Rentals" asp-action="Delete" asp-route-id="@rental.Id" class="btn btn-sm btn-danger">Delete</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>You have no rentals yet.</p>
                }
            </div>
        </div>
    </div>
</div>
<script>
async function toggleListing(itemId, button) {
    try {
        const res = await fetch(`/Items/ToggleListing/${itemId}`, {
            method: "POST"
        });

        if (!res.ok) throw new Error("Failed to toggle listing");
        const data = await res.json();

        if (data.success) {
            // Update button text and color instantly
            if (data.isListed) {
                button.classList.remove("btn-success");
                button.classList.add("btn-warning");
                button.textContent = "Unlist";
            } else {
                button.classList.remove("btn-warning");
                button.classList.add("btn-success");
                button.textContent = "List Item";
            }
        }
    } catch (err) {
        alert("Error updating item listing status.");
        console.error(err);
    }
}
</script>




