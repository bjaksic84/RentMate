@model RentMate.Models.DashboardViewModel
@{
    ViewData["Title"] = "My Dashboard";
}

<div class="container mt-5">
    <h2 class="text-center mb-4">My Dashboard</h2>

    <div class="row g-4">

        <!-- ====================== MY ITEMS SECTION ====================== -->
        <div class="col-12">
            <div class="card shadow-sm p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h4>My Items</h4>
                    <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target="#createItemForm">
                        + Add Item
                    </button>
                </div>

                <!-- CREATE ITEM FORM -->
                <div class="collapse mt-3" id="createItemForm">
                    <form asp-controller="Items" asp-action="Create" method="post">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Title</label>
                                <input name="Title" class="form-control" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Category</label>
                                <input name="Category" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Price per day (€)</label>
                                <input name="Price" type="number" step="0.01" class="form-control" required />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea name="Description" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">Create Item</button>
                        </div>
                    </form>
                </div>

                <hr />

                @if (Model.Listings?.Any() ?? false)
                {
                    <table class="table table-striped align-middle mt-3">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Price/day</th>
                                <th>Listed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var item in Model.Listings)
                        {
                            <tr>
                                <td>@item.Title</td>
                                <td>@item.Price?.ToString("C")</td>
                                <td>@(item.IsListed ? "✅" : "❌")</td>
                                <td>
                                    <button class="btn btn-sm @(item.IsListed ? "btn-warning" : "btn-success")"
                                            onclick="toggleListing(@item.Id, this)">
                                        @(item.IsListed ? "Unlist" : "List")
                                    </button>
                                    <a asp-controller="Items" asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-outline-secondary">Edit</a>
                                    <a asp-controller="Items" asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-outline-danger">Delete</a>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="mt-3">You have not listed any items yet.</p>
                }
            </div>
        </div>


        <!-- ====================== RENTALS OF MY ITEMS (OWNER) ====================== -->
        <div class="col-12">
            <div class="card shadow-sm p-4 mb-4">
                <h4 class="mb-3">Rentals of My Items (Owner)</h4>

                @if (Model.OwnerRentals?.Any() ?? false)
                {
                    <table class="table table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Renter</th>
                                <th>Status</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var rental in Model.OwnerRentals)
                        {
                            <tr>
                                <td>@rental.Item?.Title</td>
                                <td>@rental.Renter?.Email</td>
                                <td>@rental.Status</td>
                                <td>@rental.StartDate.ToShortDateString()</td>
                                <td>@rental.EndDate.ToShortDateString()</td>
                                <td>
                                    @if (rental.Status == RentalStatus.Pending)
                                    {
                                        <form asp-controller="Rentals" asp-action="ApproveRental" method="post" class="d-inline">
                                            <input type="hidden" name="rentalId" value="@rental.Id" />
                                            <button class="btn btn-sm btn-success">Approve</button>
                                        </form>
                                        <form asp-controller="Rentals" asp-action="CancelRental" method="post" class="d-inline">
                                            <input type="hidden" name="rentalId" value="@rental.Id" />
                                            <button class="btn btn-sm btn-danger">Reject</button>
                                        </form>
                                    }
                                    else if (rental.Status == RentalStatus.Active)
                                    {
                                        <form asp-controller="Rentals" asp-action="CompleteRental" method="post" class="d-inline">
                                            <input type="hidden" name="rentalId" value="@rental.Id" />
                                            <button class="btn btn-sm btn-primary">Mark Complete</button>
                                        </form>
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>No one has rented your items yet.</p>
                }
            </div>
        </div>


        <!-- ====================== MY RENTALS FROM OTHERS (RENTER) ====================== -->
        <div class="col-12">
            <div class="card shadow-sm p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h4>My Rentals from Others (Renter)</h4>
                    <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target="#createRentalForm">
                        + Request Rental
                    </button>
                </div>

                <!-- REQUEST RENTAL FORM -->
                <div class="collapse mt-3" id="createRentalForm">
                    <form asp-controller="Rentals" asp-action="RequestRental" method="post">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Select Item</label>
                                <select class="form-select" name="itemId" required>
                                    <option value="">-- Select --</option>
                                    @foreach (var item in Model.Listings.Where(i => i.IsListed && !i.IsRented))
                                    {
                                        <option value="@item.Id">@item.Title (@item.Price?.ToString("C")/day)</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" name="startDate" required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" name="endDate" required />
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">Request Rental</button>
                        </div>
                    </form>
                </div>

                <hr />

                @if (Model.MyRentals?.Any() ?? false)
                {
                    <table class="table table-bordered align-middle mt-3">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Owner</th>
                                <th>Status</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var rental in Model.MyRentals)
                        {
                            <tr>
                                <td>@rental.Item?.Title</td>
                                <td>@rental.Owner?.Email</td>
                                <td>@rental.Status</td>
                                <td>@rental.StartDate.ToShortDateString()</td>
                                <td>@rental.EndDate.ToShortDateString()</td>
                                <td>
                                    @if (rental.Status == RentalStatus.Active)
                                    {
                                        <form asp-controller="Rentals" asp-action="CompleteRental" method="post" class="d-inline">
                                            <input type="hidden" name="rentalId" value="@rental.Id" />
                                            <button class="btn btn-sm btn-primary">Return Item</button>
                                        </form>
                                    }
                                    else if (rental.Status == RentalStatus.Pending)
                                    {
                                        <form asp-controller="Rentals" asp-action="CancelRental" method="post" class="d-inline">
                                            <input type="hidden" name="rentalId" value="@rental.Id" />
                                            <button class="btn btn-sm btn-danger">Cancel Request</button>
                                        </form>
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>You have no rentals from other users yet.</p>
                }
            </div>
        </div>

    </div>
</div>

<script>
async function toggleListing(itemId, button) {
    try {
        const res = await fetch(`/Items/ToggleListing/${itemId}`, { method: "POST" });
        if (!res.ok) throw new Error("Failed to toggle listing");
        const data = await res.json();
        if (data.success) {
            if (data.isListed) {
                button.classList.remove("btn-success");
                button.classList.add("btn-warning");
                button.textContent = "Unlist";
            } else {
                button.classList.remove("btn-warning");
                button.classList.add("btn-success");
                button.textContent = "List";
            }
        }
    } catch (err) {
        alert("Error updating listing status");
        console.error(err);
    }
}
</script>






